
from evm.vm import vm_execute, Message
from evm import utils

import math
import pdb

GenesisParams = '\
pragma solidity ^0.4.21;\n\
\n\
import "./GenesisPermission.sol";\n\
\n\
contract GenesisParams {\n\
\n\
    mapping (bytes => bytes) parameters;\n\
\n\
    function GenesisParams() public {\n\
        parameters["param_set_permission_addr"] = hex"0000000000000000000000000000000000000002";\n\
        parameters["check_tx_addr"] = hex"0000000000000000000000000000000000000003";\n\
        parameters["deliver_tx_addr"] = hex"0000000000000000000000000000000000000004";\n\
    }\n\
\n\
    function get_param(bytes name) public view returns(bytes) {\n\
        return parameters[name];\n\
    }\n\
\n\
    function bytesToAddress(bytes _address) private pure returns (address) {\n\
        uint160 m = 0;\n\
        uint160 b = 0;\n\
\n\
        for (uint8 i = 0; i < 20; i++) {\n\
            m *= 256;\n\
            b = uint160(_address[i]);\n\
            m += (b);\n\
        }\n\
\n\
        return address(m);\n\
    }\n\
\n\
    function set_param(bytes name, bytes param, bytes proof) public {\n\
        bytes memory address_str = parameters["param_set_permission_addr"];\n\
        address addr = bytesToAddress(address_str);\n\
        GenesisPermission gp = GenesisPermission(addr);\n\
        if(gp.CheckPermission(name,param,proof)) {\n\
            parameters[name] = param;\n\
        }\n\
    }\n\
}'

GenesisParamsBytes = bytes.fromhex('608060405234801561001057600080fd5b506040805190810160405280601481526020016c02000000000000000000000000815250600060405180807f706172616d5f7365745f7065726d697373696f6e5f6164647200000000000000815250601901905090815260200160405180910390209080519060200190610085929190610175565b506040805190810160405280601481526020016c03000000000000000000000000815250600060405180807f636865636b5f74785f6164647200000000000000000000000000000000000000815250600d019050908152602001604051809103902090805190602001906100fa929190610175565b506040805190810160405280601481526020016c04000000000000000000000000815250600060405180807f64656c697665725f74785f616464720000000000000000000000000000000000815250600f0190509081526020016040518091039020908051906020019061016f929190610175565b5061021a565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106101b657805160ff19168380011785556101e4565b828001600101855582156101e4579182015b828111156101e35782518255916020019190600101906101c8565b5b5090506101f191906101f5565b5090565b61021791905b808211156102135760008160009055506001016101fb565b5090565b90565b61082d806102296000396000f30060806040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680631b52a43914610051578063ee13801114610146575b600080fd5b34801561005d57600080fd5b50610144600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610228565b005b34801561015257600080fd5b506101ad600480360381019080803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929050505061058b565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156101ed5780820151818401526020810190506101d2565b50505050905090810190601f16801561021a5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6060600080600060405180807f706172616d5f7365745f7065726d697373696f6e5f6164647200000000000000815250601901905090815260200160405180910390208054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156102ff5780601f106102d4576101008083540402835291602001916102ff565b820191906000526020600020905b8154815290600101906020018083116102e257829003601f168201915b5050505050925061030f83610698565b91508190508073ffffffffffffffffffffffffffffffffffffffff1663af25082a8787876040518463ffffffff167c010000000000000000000000000000000000000000000000000000000002815260040180806020018060200180602001848103845287818151815260200191508051906020019080838360005b838110156103a657808201518184015260208101905061038b565b50505050905090810190601f1680156103d35780820380516001836020036101000a031916815260200191505b50848103835286818151815260200191508051906020019080838360005b8381101561040c5780820151818401526020810190506103f1565b50505050905090810190601f1680156104395780820380516001836020036101000a031916815260200191505b50848103825285818151815260200191508051906020019080838360005b83811015610472578082015181840152602081019050610457565b50505050905090810190601f16801561049f5780820380516001836020036101000a031916815260200191505b509650505050505050602060405180830381600087803b1580156104c257600080fd5b505af11580156104d6573d6000803e3d6000fd5b505050506040513d60208110156104ec57600080fd5b81019080805190602001909291905050501561058357846000876040518082805190602001908083835b60208310151561053b5780518252602082019150602081019050602083039250610516565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020908051906020019061058192919061075c565b505b505050505050565b60606000826040518082805190602001908083835b6020831015156105c557805182526020820191506020810190506020830392506105a0565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390208054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561068c5780601f106106615761010080835404028352916020019161068c565b820191906000526020600020905b81548152906001019060200180831161066f57829003601f168201915b50505050509050919050565b6000806000806000925060009150600090505b60148160ff1610156107515761010083029250848160ff168151811015156106cf57fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000027f010000000000000000000000000000000000000000000000000000000000000090049150818301925080806001019150506106ab565b829350505050919050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061079d57805160ff19168380011785556107cb565b828001600101855582156107cb579182015b828111156107ca5782518255916020019190600101906107af565b5b5090506107d891906107dc565b5090565b6107fe91905b808211156107fa5760008160009055506001016107e2565b5090565b905600a165627a7a72305820c09c48849a97f26a6033ade75068f57f0103daddd42accd3b77c964150d79f190029')

GenesisPermission = '\
pragma solidity ^0.4.21;\n\
\n\
contract GenesisPermission {\n\
\n\
    function CheckPermission(bytes name, bytes param, bytes proof) public pure returns(bool) {\n\
        return name.length+param.length+proof.length > 0;\n\
    }\n\
}'

GenesisCheckTx = '\
pragma solidity ^0.4.21;\n\
\n\
contract GenesisCheckTx {\n\
\n\
    function CheckTx(bytes _tx) public pure returns(bool) {\n\
        return _tx.length>0;\n\
    }\n\
}'

GenesisCheckTxBytes = bytes.fromhex('608060405234801561001057600080fd5b5060fb8061001f6000396000f300608060405260043610603f576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063d17c247d146044575b600080fd5b348015604f57600080fd5b5060a8600480360381019080803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929050505060c2565b604051808215151515815260200191505060405180910390f35b60008082511190509190505600a165627a7a72305820b3fe654b33c421c739352007c22da9056142e27078c00cf74d7b77a7b7b098f00029')

GenesisDeliverTx = '\
pragma solidity ^0.4.21;\n\
\n\
contract GenesisDeliverTx {\n\
\n\
    function DeliverTx(bytes32[] _tx) public pure returns(bytes32 from, bytes32 to, bytes32[] data) {\n\
        from = _tx[0];\n\
        to = _tx[1];\n\
        uint l = _tx.length;\n\
        data = new bytes32[](l-2);\n\
        for(uint i = 0; i < l-2; ++i) {\n\
            data[i] = _tx[i+2];\n\
        }\n\
    }\n\
}'

GenesisDeliverTxBytes = bytes.fromhex('608060405234801561001057600080fd5b50610269806100206000396000f300608060405260043610610041576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063f9a6b89514610046575b600080fd5b34801561005257600080fd5b506100b4600480360381019080803590602001908201803590602001908080602002602001604051908101604052809392919081815260200183836020028082843782019150505050505091929192908035906020019092919050505061015c565b60405180856bffffffffffffffffffffffff19166bffffffffffffffffffffffff19168152602001846bffffffffffffffffffffffff19166bffffffffffffffffffffffff1916815260200180602001838152602001828103825284818151815260200191508051906020019060200280838360005b8381101561014557808201518184015260208101905061012a565b505050509050019550505050505060405180910390f35b600080606060008086600081518110151561017357fe5b90602001906020020151945086600181518110151561018e57fe5b90602001906020020151935060408603915060028751036040519080825280602002602001820160405280156101d35781602001602082028038833980820191505090505b509250600090505b60028751038110156102335786600282018151811015156101f857fe5b90602001906020020151838281518110151561021057fe5b9060200190602002019060001916908160001916815250508060010190506101db565b50929591945092505600a165627a7a723058208fae37c2f52dbe28a47928b1a43196aa159da9c8ad9341de3770f684a4d3bee90029')

addr0 = bytes.fromhex('0000000000000000000000000000000000000000')
addr1 = bytes.fromhex('0000000000000000000000000000000000000001')
addr2 = bytes.fromhex('0000000000000000000000000000000000000002')
addr3 = bytes.fromhex('0000000000000000000000000000000000000003')
addr4 = bytes.fromhex('0000000000000000000000000000000000000004')
check_tx_addr_req = bytes.fromhex('ee1380110000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000d636865636b5f74785f6164647200000000000000000000000000000000000000')
check_tx_call_prefix = bytes.fromhex('d17c247d0000000000000000000000000000000000000000000000000000000000000020')
deliver_tx_addr_req = bytes.fromhex('ee1380110000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000f64656c697665725f74785f616464720000000000000000000000000000000000')
deliver_tx_call_prefix = bytes.fromhex('f9a6b8950000000000000000000000000000000000000000000000000000000000000040')

class Blockchain():

    def __init__(self):
        self.block_prevhash = 0
        self.block_coinbase = 0
        self.block_timestamp = 0
        self.block_number = 0
        self.block_difficulty = 0
        self.block_gas_limit = 0
        self.tx_origin = b'0' * 40
        self.tx_gasprice = 0

        self.storage = {}
        self.height = 1
        self.uncommited_tx_count = 0
        self.nonce = 5
        
        result,gas,memory = vm_execute(self,Message(addr0,addr1),GenesisParamsBytes)
        self.code = {addr1:bytes(memory)}
        result,gas,memory = vm_execute(self,Message(addr0,addr3),GenesisCheckTxBytes)
        self.code.update({addr3:bytes(memory)})
        result,gas,memory = vm_execute(self,Message(addr0,addr4),GenesisDeliverTxBytes)
        self.code.update({addr4:bytes(memory)})

    def __repr__(self):
        return str({"code":self.code,"storage":self.storage})
        
    def get_code(self, addr):
        print('\n**** get_code ****\n')
        return b''
        
    def get_balance(self, addr):
        print('\n**** get_balance ****\n')
        return 0
        
    def set_balance(self, addr, balance):
        print('\n**** set_balance ****\n')
        return 0
        
    def set_storage_data(self, addr, key, value):
        print('\n**** set_storage_data ****')
        a=self.storage.get(addr,{})
        a.update({key:value})
        self.storage.update({addr:a})
        print(self.storage)
        print('**** set_storage_data ****\n')

    def get_storage_data(self, addr, key):
        print('\n**** get_storage_data ****')
        a=self.storage.get(addr,{})
        b=a.get(key,0)
        print(addr,key,b)
        print('**** get_storage_data ****\n')
        return b

    def log_storage(self, addr):
        print('\n**** log_storage ****\n')
        return 0

    def add_suicide(self, addr):
        print('\n**** add_suicide ****\n')
        return 0

    def add_refund(self, x):
        print('\n**** add_refund ****\n')
        return 0

    def log(self, addr, topics, data):
        print('\n**** log ****\n')
        return 0

    def create(self, msg):
        print('\n**** create ****\n')
        return 0, 0, 0

    def call(self, msg):
        print('\n**** call ****\n')
        return 0, 0, 0

    def sendmsg(self, msg):
        print('\n**** sendmsg ****\n')
        return 0, 0, 0
        
    def call_address(self, fromAddr, toAddr, data):
        code = self.code.get(toAddr,None)
        if(code != None):
            result,gas,memory = vm_execute(self,Message(fromAddr,toAddr,data=data),code)
        return memory
        
    def check_tx(self,data):
        result = self.call_address(addr0,addr1,check_tx_addr_req)
        ressize = utils.bytearray_to_int(result[32:64])
        checktxaddr = bytes(result[64:(64+ressize)])
        bdata = bytearray.fromhex(data.decode("utf-8"))
        call_data = check_tx_call_prefix+utils.encode_int32(len(bdata))+bdata
        result = self.call_address(addr0,checktxaddr,call_data)
        return utils.bytearray_to_int(result)

    def deliver_tx(self,data):
        # get deliver_tx address
        result = self.call_address(addr0,addr1,deliver_tx_addr_req)
        ressize = utils.bytearray_to_int(result[32:64])
        delivertxaddr = bytes(result[64:(64+ressize)])
        
        # call deliver_tx
        bdata = bytearray.fromhex(data.decode("utf-8"))
        call_data = deliver_tx_call_prefix+utils.encode_int32(len(bdata))+utils.encode_int32(math.ceil(len(bdata)/32))+bdata
        result = self.call_address(addr0,delivertxaddr,call_data)
        
        # get transaction data
        fromAddr = bytes(result[0:20])
        toAddr = bytes(result[32:52])
        length = utils.bytearray_to_int(result[96:128])
        codeData = bytes(result[160:160+length])
        
        # execute transaction
        if(toAddr==addr0):
            new_address = utils.int_to_addr(self.nonce)
            self.nonce += 1
            result,gas,memory = vm_execute(self,Message(fromAddr,new_address),codeData)
            self.code.update({new_address:bytes(memory)})
            result = new_address
        else:
            result = self.call_address(fromAddr,toAddr,call_data)
        self.uncommited_tx_count += 1
            
        return result
